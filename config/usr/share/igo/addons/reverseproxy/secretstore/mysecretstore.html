<!DOCTYPE html>
<html>
  <head>
    <title>My Secret Store</title>
  </head>
  <body>
    <div id="cookieName" style="display: none">{{ .cookie }}</div>

    <input id="virtualDomain" type="text" value="rsh" />
    <button onclick="setPermanentCookie()">set subdomain prefix</button>
    <button id="testNotification" onclick="testNotification()">
      test Notification
    </button>

    <script>
      sw = undefined;

      function testNotification() {
        sw.postMessage("show-notification");
      }

      function setPermanentCookie() {
        // Set cookie to expire in 10 years
        var value =
          document.querySelector("#virtualDomain").value +
          `.${window.location.host}`;
        var name = document.querySelector("#cookieName").textContent;
        var expires = new Date();
        expires.setFullYear(expires.getFullYear() + 10);
        document.cookie =
          name +
          "=" +
          encodeURIComponent(value) +
          ";expires=" +
          expires.toUTCString() +
          ";path=/";
      }

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("mysecretstore.sw.js")
          .then((registration) => {
            console.log("Service Worker registered", registration);
            // Request notification permission
            if (registration.installing) {
              console.log("Service worker installing");
            } else if (registration.waiting) {
              console.log("Service worker installed");
            } else if (registration.active) {
              console.log("Service worker active");
            }
            Notification.requestPermission().then((permission) => {
              if (permission !== "granted") {
                alert("Notification permission denied");
              }
            });

            navigator.serviceWorker.ready.then((reg) => {
              console.log("Service Worker ready", reg);
              sw = reg.active;
              // sw.postMessage("start-notification");
            });

            // Send message to service worker to show notification
            document
              .getElementById("notifyBtn")
              .addEventListener("click", () => {
                if (navigator.serviceWorker.controller) {
                  navigator.serviceWorker.controller.postMessage(
                    "show-notification"
                  );
                } else {
                  console.warn("No active service worker controller found.");
                }
              });
          });
      }
      // async function load(name) {
      //   const rawResponse = await fetch("/remote-dev-localstorage-loader", {
      //     method: "POST",
      //     headers: {
      //       Accept: "application/json",
      //       "Content-Type": "application/json",
      //     },
      //     body: JSON.stringify({
      //       storage: localStorage.getItem("storage"),
      //     }),
      //   });
      //   const content = await rawResponse.json();
      //   console.log(content);

      //   setInterval(async () => {
      //     const healthCheck = await fetch("/", {
      //       method: "get",
      //     });
      //     const resp = await healthCheck.text();
      //     healthCheck.status < 300
      //       ? console.log("Health check passed")
      //       : console.error("Health check failed");
      //     if (healthCheck.status < 300) {
      //       console.log("Endpoint is healthy");
      //       window.location.href = "/";
      //     }
      //   }, 1000);
      // }
      // load();
    </script>
  </body>
</html>
